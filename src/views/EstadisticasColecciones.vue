<template>
  <div class="p-6">
    <h2 class="text-2xl font-bold mb-6 text-gray-800">
      游늵 Estad칤sticas de Colecciones
    </h2>

    <!-- Filtro -->
    <div class="flex items-center gap-4 mb-4">
      <select v-model="selectedColeccion" class="border rounded p-2">
        <option value="">Todas las colecciones</option>
        <option v-for="c in colecciones" :key="c.id" :value="c.id">
          {{ c.nombre }}
        </option>
      </select>
      <button @click="cargarEstadisticas" class="bg-blue-500 text-white px-4 py-2 rounded">
        Filtrar
      </button>
    </div>

    <!-- Tabla -->
    <table class="min-w-full border border-gray-300">
      <thead>
        <tr class="bg-gray-100">
          <th class="border px-4 py-2">Colecci칩n</th>
          <th class="border px-4 py-2">Total Vistas</th>
          <th class="border px-4 py-2">칔ltimo Registro</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="item in estadisticas.data" :key="item.tipo_colleccion_id">
          <td>
            {{ item.coleccion?.nombre || 'ID: ' + item.tipo_colleccion_id }}
          </td>
          <td>{{ item.total_vistas }}</td>
          <td>{{ formatDate(item.ultimo_registro) }}</td>
        </tr>
      </tbody>
    </table>

    <!-- Paginaci칩n -->
    <div class="mt-4 flex gap-2 items-center">
      <button @click="cambiarPagina(page - 1)" :disabled="page <= 1"
              class="px-3 py-1 bg-gray-300 rounded disabled:opacity-50">
        Anterior
      </button>
      <span>P치gina {{ page }} de {{ lastPage }}</span>
      <button @click="cambiarPagina(page + 1)" :disabled="page >= lastPage"
              class="px-3 py-1 bg-gray-300 rounded disabled:opacity-50">
        Siguiente
      </button>
    </div>

    <!-- Error -->
    <div v-if="errorMsg" class="mt-4 text-red-500 font-medium p-2 border border-red-500 bg-red-50">
      {{ errorMsg }}
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import axios from 'axios';

// Variables reactivas
const colecciones = ref([]);
const selectedColeccion = ref('');
const estadisticas = ref({ data: [] });
const page = ref(1);
const numero_items = ref(10);
const lastPage = ref(1);
const errorMsg = ref('');

// Reiniciar estad칤sticas
const resetStats = () => {
  estadisticas.value = { data: [] };
  lastPage.value = 1;
};

// Cargar colecciones
async function cargarColecciones() {
  try {
    const res = await axios.get('http://127.0.0.1:8000/api/tipocollecciones');
    colecciones.value = res.data.obj || []; 
    console.log("Colecciones recibidas:", colecciones.value);
  } catch (error) {
    console.error("Error al cargar colecciones:", error);
  }
}

// Cargar estad칤sticas
async function cargarEstadisticas() {
  try {
    errorMsg.value = '';

    // Convertir ID a entero o null
    const filterId = selectedColeccion.value ? parseInt(selectedColeccion.value) : null;

    const res = await axios.post('http://127.0.0.1:8000/api/vistas/listar', {
      tipo_colleccion_id: filterId,
      page: page.value,
      numero_items: numero_items.value
    });

    if (res.data.state !== 202) {
      errorMsg.value = res.data.msg?.[0] || "Error al cargar estad칤sticas: Estado no exitoso.";
      resetStats();
      return;
    }

    estadisticas.value = res.data.obj || { data: [] };
    page.value = estadisticas.value.current_page || 1;
    lastPage.value = estadisticas.value.last_page || 1;

    console.log("Estad칤sticas recibidas:", estadisticas.value);

  } catch (error) {
    console.error("Error al cargar estad칤sticas:", error);

    const backendData = error.response?.data;
    const statusCode = error.response?.status;

    if (backendData?.msg) {
      errorMsg.value = `(${statusCode}) ${backendData.msg[0] || "Error en la respuesta del servidor."}`;
    } else if (statusCode) {
      errorMsg.value = `Error de red o servidor: ${statusCode} ${error.message}`;
    } else {
      errorMsg.value = "Error de conexi칩n o configuraci칩n al cargar las estad칤sticas.";
    }

    resetStats();
  }
}

// Cambiar p치gina
function cambiarPagina(p) {
  if (p >= 1 && p <= lastPage.value) {
    page.value = p;
    cargarEstadisticas();
  }
}

// Formatear fecha
function formatDate(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  return d.toLocaleString();
}

// Al montar
onMounted(async () => {
  await cargarColecciones();
  await cargarEstadisticas();
});
</script>

<style scoped>
table { border-collapse: collapse; }
th, td { text-align: left; }
</style>
